<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 BLE Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<style>
:root{
  --bg:#0b1220; --panel:#121a2f; --card:#17223b;
  --primary:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --text:#ffffff; --muted:#94a3b8; --border:#1e293b;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,sans-serif;background:radial-gradient(circle at top,#0f172a,#020617);color:var(--text);}
header{padding:18px 24px;border-bottom:1px solid var(--border);background:#020617;}
header h1{margin:0;font-size:20px;font-weight:600;}
main{padding:24px;max-width:1000px;margin:auto;}
.card{background:linear-gradient(180deg,var(--card),var(--panel));border:1px solid var(--border);border-radius:16px;padding:22px;box-shadow:0 20px 40px rgba(0, 0, 0, 0.35);}
button{border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;margin-right:6px;}
#btnConnect{background:linear-gradient(135deg,var(--primary),#2563eb); color:white;}
#btnCSV{background:linear-gradient(135deg,#06bd3d,#06bd3d); color:white;}
#btnResetZoom{background:linear-gradient(135deg,hwb(59 1% 25%),hwb(59 1% 25%)); color:white;}
#btnSD{background:linear-gradient(136deg,#fb2424,#b45309); color:white;}
#btnClearSD{background:linear-gradient(135deg,#3b82f6,#2563eb); color:white;}

#status{margin-left:12px;font-weight:600;padding:6px 12px;border-radius:10px;background:var(--panel);}
.status-connected{
  background: linear-gradient(135deg,#22c55e,#4ade80);
  color:#ffffff;
  box-shadow: 0 0 0 2px rgba(3, 199, 75, 0.35),
              0 0 18px rgba(3, 199, 75, 0.45);
}
.tabs{display:flex; gap:6px; margin-top:16px; flex-wrap: wrap;}
.tab{padding:8px 16px;border-radius:10px;background:var(--panel);cursor:pointer;font-weight:600;}
.tab.active{background:var(--primary); color:white;}
.tabContent{display:none; margin-top:16px;}
.tabContent.active{display:block;}
.value{background:#020617;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;}
.value h3{margin:0; font-size:14px; color:var(--muted);}
.value p{margin:6px 0 0; font-size:28px; font-weight:700;}
.temp{color:var(--danger)}
.volt{color:var(--primary)}
.corr{color:var(--ok)}
.bat{color:var(--warn)}
.stats{display:flex; gap:12px; margin-bottom:12px;}
.statBox{background:#121a2f;border:1px solid var(--border);border-radius:12px;padding:12px;flex:1;text-align:center;}
.statBox h4{margin:0; font-size:12px; color:var(--muted);}
.statBox p{margin:4px 0 0; font-size:16px; font-weight:600;}
canvas{background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:12px;padding:8px;}
input.sliderX{-webkit-appearance: none;width: 100%;height: 6px;border-radius: 5px;background: rgba(148,163,184,0.3);outline: none;margin-top:12px;}
input.sliderX::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width: 14px;height: 14px;border-radius: 50%;background: var(--primary);cursor: pointer;}
#debug{margin-top:16px;background:#020617;border:1px solid var(--border);border-radius:12px;padding:12px;height:140px;overflow-y:auto;font-family:monospace;font-size:12px;}
#recIndicator { display: inline-flex; align-items: center; gap:25px; font-size:15px; justify-content:center; width:100%; margin-top:4px;}
.rec-dot{font-weight:800;color:inherit; animation:inherit;}
.rec-time{font-weight:600;color:var(--text); min-width:40px; text-align:center;}
@keyframes blink {0% { opacity: 1; } 50% { opacity: 0.25; } 100% { opacity: 1; }}
.rec-on{color:white;background:#dc2626;box-shadow:0 0 10px rgba(220,38,38,.9);animation: blink 1s infinite;padding: 2px 6px;border-radius: 4px;font-weight:800;}
.rec-off{color:#64748b;background:#020617;border:1px solid #1e293b;padding: 6px 14px;border-radius:12px;font-weight:800;}


/* MOBILE OPTIMIZATION  */
 
   @media (max-width: 768px) {

  header {
    padding: 12px 16px;
  }

  header h1 {
    font-size: 16px;
    text-align: center;
  }

  main {
    padding: 12px;
    max-width: 100%;
  }

  .card {
    padding: 14px;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* ===== BOTONES ===== */
  .card > button,
  .card > div button {
    width: 100%;
    margin: 4px 0;
    padding: 12px;
    font-size: 14px;
  }

  #status {
    display: block;
    margin: 8px 0 0;
    text-align: center;
  }

  /* ===== TABS ===== */
  .tabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
  }

  .tab {
    padding: 8px;
    font-size: 12px;
    text-align: center;
  }

  /* ===== VALUES ===== */
  .value {
    padding: 12px;
  }

  .value h3 {
    font-size: 12px;
  }

  .value p {
    font-size: 22px;
  }

  /* ===== STATS ===== */
  .stats {
    gap: 8px;
  }

  .statBox {
    padding: 10px;
  }

  .statBox p {
    font-size: 14px;
  }

  /* ===== CANVAS ===== */
  canvas {
    width: 100% !important;
    height: 220px !important;
  }

  /* ===== DEBUG ===== */
  #debug {
    height: 110px;
    font-size: 11px;
  }

}

#recIndicator {
  display: inline-flex;       
  align-items: center;        
  gap: 25px;                   
  font-size: 15px;


  display: flex;
  justify-content: center;
  width: 100%;                
  margin-top: 4px;            
}

.rec-dot {
  font-weight: 800;
  color: inherit;             
  animation: inherit;         
}

.rec-time {
  font-weight: 600;
  color: var(--text);
  min-width: 40px;            
  text-align: center;         
}


@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.25; }
  100% { opacity: 1; }
}

.rec-on{
  color:white;
  background:#dc2626;
  box-shadow:0 0 10px rgba(220,38,38,.9);
  animation: blink 1s infinite;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 800;
}

.rec-off{
  color:#64748b;
  background:#020617;
  border:1px solid #1e293b;
  padding: 6px 14px;
  border-radius: 12px;
  font-weight: 800;
}


/* ===== STATUS + RESET ===== */
    .status-row{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* ===== HEADER MOBILE ===== */
    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    /* ===== RESET BUTTON ===== */
    #btnRST,
    #btnRSTmobile{
      width:38px;
      height:38px;
      border-radius:10px;
      font-size:18px;
      font-weight:900;
      background:#020617;
      color:#ef4444;
      border:1px solid #1e293b;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #btnRST:hover,
    #btnRSTmobile:hover{
      background:#ef4444;
      color:white;
    }

    /* RESPONSIVE */
    @media (max-width:768px){
      .status-row{ display:none; }
    }

#btnRST{
  display:none;
}


.card .top-row,
.card .status-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

#statusSD {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 8px;
  min-width: 185px;
  flex: 1 1 auto;
}

/* Indicador REC dentro de SD */
#statusSD #recIndicator {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  font-size: 14px;
}

#statusSD .rec-dot.rec-on {
  font-weight: 800;
  color: white;
  background: #dc2626;
  box-shadow: 0 0 10px rgba(220,38,38,.9);
  animation: blink 1s infinite;
  padding: 2px 6px;
  border-radius: 4px;
}


#statusSD .rec-time {
  font-weight: 600;
  color: var(--text);
  min-width: 40px;
  text-align: center;
}

/* Mensajes SD */
#statusSD #sdMessages {
  height: 20px;
  overflow: hidden;
  white-space: nowrap;
  font-family: monospace;
  font-size: 8px;
  padding: 2px 6px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--panel);
}

/* Animaci√≥n REC */
.rec-on {
  color: white;
  background: #dc2626;
  box-shadow: 0 0 10px rgba(220,38,38,.9);
  animation: blink 1s infinite;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 800;
}

.rec-off {
  color: #726666;
  background: #000000;
  border: 1px solid #2f2644;
  padding: 6px 14px;
  border-radius: 12px;
  font-weight: 800;
}

/* ================== MOBILE ================== */
@media (max-width: 768px){
  #statusSD {
    flex-direction: column;
  }

  #statusSD #recIndicator {
    font-size: 12px;
    gap: 8px;
  }

  #statusSD #sdMessages {
    height: 24px;
    font-size: 8px;
  }
}


  </style>
</head>
<body>
<header>
  <div class="header-row">
    <h1>ESP32 ¬∑ BLE Dashboard</h1>
    <button id="btnRSTmobile" title="Reset ESP32">‚èª</button>
  </div>
</header>
<main>
<div class="card">
  <button id="btnConnect">Conectar ESP32</button>
  <button id="btnCSV">Exportar CSV</button>
  <button id="btnSD">REC SD</button>
  <button id="btnClearSD">Formatear SD</button>
  <button id="btnResetZoom">Reset Zoom</button>
  <span id="status">Estado: Desconectado</span>

 <!-- SD con REC integrado -->
<div id="statusSD" class="card" style="flex: 1 1 auto; min-width:185px; padding:8px; display:flex; flex-direction:column; gap:6px;">
  <!-- REC arriba -->
  <div id="recIndicator" class="rec-off" style="display:flex; justify-content:center; align-items:center; gap:12px; font-size:14px;">
    <span class="rec-dot">‚óè REC</span>
    <span class="rec-time">00:00</span>
  </div>

  <!-- Mensajes SD abajo -->
  <div id="sdMessages" style="height:24px; font-size:13px;"></div>







<div class="tabs">
  <div class="tab active" data-tab="all">Todos</div>
  <div class="tab" data-tab="temp">Temperatura</div>
  <div class="tab" data-tab="volt">Voltaje</div>
  <div class="tab" data-tab="corr">Corriente</div>
  <div class="tab" data-tab="bat">Bater√≠a</div>
</div>

<div id="all" class="tabContent active">
  <div class="value"><h3>Temperatura</h3><p class="temp" id="valTempAll">-- ¬∞C</p></div>
  <div class="value"><h3>Voltaje</h3><p class="volt" id="valVoltAll">-- V</p></div>
  <div class="value"><h3>Corriente</h3><p class="corr" id="valCorrAll">-- A</p></div>
  <div class="value"><h3>Bater√≠a</h3><p class="bat" id="valBatAll">--</p></div>
  <div id="debug"></div>
</div>

<div id="temp" class="tabContent">
  <div class="value"><h3>Temperatura</h3><p class="temp" id="valTemp">-- ¬∞C</p></div>
  <div class="stats">
    <div class="statBox"><h4>Promedio</h4><p id="avgTemp">--</p></div>
    <div class="statBox"><h4>M√°ximo</h4><p id="maxTemp">--</p></div>
    <div class="statBox"><h4>M√≠nimo</h4><p id="minTemp">--</p></div>
  </div>
  <canvas id="chartTemp" height="150"></canvas>
  <input type="range" class="sliderX" min="0" max="0" value="0">
</div>

<div id="volt" class="tabContent">
  <div class="value"><h3>Voltaje</h3><p class="volt" id="valVolt">-- V</p></div>
  <div class="stats">
    <div class="statBox"><h4>Promedio</h4><p id="avgVolt">--</p></div>
    <div class="statBox"><h4>M√°ximo</h4><p id="maxVolt">--</p></div>
    <div class="statBox"><h4>M√≠nimo</h4><p id="minVolt">--</p></div>
  </div>
  <canvas id="chartVolt" height="150"></canvas>
  <input type="range" class="sliderX" min="0" max="0" value="0">
</div>

<div id="corr" class="tabContent">
  <div class="value"><h3>Corriente</h3><p class="corr" id="valCorr">-- A</p></div>
  <div class="stats">
    <div class="statBox"><h4>Promedio</h4><p id="avgCorr">--</p></div>
    <div class="statBox"><h4>M√°ximo</h4><p id="maxCorr">--</p></div>
    <div class="statBox"><h4>M√≠nimo</h4><p id="minCorr">--</p></div>
  </div>
  <canvas id="chartCorr" height="150"></canvas>
  <input type="range" class="sliderX" min="0" max="0" value="0">
</div>

<div id="bat" class="tabContent">
  <div class="value"><h3>Bater√≠a</h3><p class="bat" id="valBat">--</p></div>
</div>

<script>
// ================== Variables ==================
const recIndicator = document.getElementById("recIndicator");
let device=null, characteristicRX=null, characteristicTX=null;
let recordingSD=false, startTime=null, timerInterval=null;
const dataCSV=[], dataTemp=[], dataVolt=[], dataCorr=[];
const dataTempHist=[], dataVoltHist=[], dataCorrHist=[];
const MAX_POINTS=50;
let autoScrollTemp=true, autoScrollVolt=true, autoScrollCorr=true;
let sdQueue = [];        // Cola de mensajes SD pendientes
let sdDisplaying = false; // Flag si ya se est√° mostrando un mensaje


// Elementos HTML
const btnConnect=document.getElementById('btnConnect');
const btnCSV=document.getElementById('btnCSV');
const btnSD=document.getElementById('btnSD');
const btnClearSD=document.getElementById('btnClearSD');
const btnResetZoom=document.getElementById('btnResetZoom');
const btnRST=document.getElementById('btnRST');
const sdMessages = document.getElementById('sdMessages');
//const btnClearSDLog = document.getElementById('btnClearSDLog');



const status=document.getElementById('status');
const debug=document.getElementById('debug');
function log(msg){
  debug.textContent += msg + "\n";
  debug.scrollTop = debug.scrollHeight;
}

//btnClearSDLog.onclick = () => {
  //sdMessages.textContent = "";
//};


const valTempAll=document.getElementById('valTempAll');
const valVoltAll=document.getElementById('valVoltAll');
const valCorrAll=document.getElementById('valCorrAll');
const valBatAll=document.getElementById('valBatAll');

const valTemp=document.getElementById('valTemp');
const valVolt=document.getElementById('valVolt');
const valCorr=document.getElementById('valCorr');
const valBat=document.getElementById('valBat');

const avgTemp=document.getElementById('avgTemp');
const maxTemp=document.getElementById('maxTemp');
const minTemp=document.getElementById('minTemp');
const avgVolt=document.getElementById('avgVolt');
const maxVolt=document.getElementById('maxVolt');
const minVolt=document.getElementById('minVolt');
const avgCorr=document.getElementById('avgCorr');
const maxCorr=document.getElementById('maxCorr');
const minCorr=document.getElementById('minCorr');

const sliders={
  temp: document.querySelector('#temp .sliderX'),
  volt: document.querySelector('#volt .sliderX'),
  corr: document.querySelector('#corr .sliderX')
};

// ================== Funciones ==================
function logSD(msg){
  sdQueue.push(msg);      // agregamos mensaje a la cola
  if(!sdDisplaying) showNextSD(); // si no se estaba mostrando nada, arrancamos
}

function showNextSD(){
  if(sdQueue.length === 0){
    sdDisplaying = false;
    return;
  }

  sdDisplaying = true;
  const msg = sdQueue.shift();  // sacamos el primer mensaje
  sdMessages.textContent = msg;

  // Mostrar cada mensaje m√≠nimo 1.5 segundos
  setTimeout(() => {
    showNextSD();  // mostramos el siguiente mensaje si hay
  }, 1500); 
}



// Tabs
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tabContent').forEach(c=>c.classList.toggle('active', c.id===tab.dataset.tab));
  }
});

// Crear charts
function crearChart(canvas,label,color){
  return new Chart(canvas,{
    type:'line',
    data:{labels:[], datasets:[{label,data:[],borderColor:color,backgroundColor:'rgba(255,255,255,0.06)',fill:true,tension:0.4,cubicInterpolationMode:'monotone',pointRadius:4,pointHoverRadius:6,borderWidth:4}]},
    options:{
      animation:{duration:300,easing:'linear'},
      responsive:true,
      plugins:{
        legend:{labels:{color:'#e5e7eb'}},
        zoom:{pan:{enabled:true,mode:'x'}, zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}}
      },
      scales:{x:{grid:{color:'rgba(148,163,184,0.08)'},ticks:{color:'#94a3b8'}}, y:{grid:{color:'rgba(148,163,184,0.08)'},ticks:{color:'#94a3b8'},min:0}}
    }
  });
}

const chartTemp=crearChart(document.getElementById('chartTemp'),'Temperatura (¬∞C)','#ef4444');
const chartVolt=crearChart(document.getElementById('chartVolt'),'Voltaje (V)','#3b82f6');
const chartCorr=crearChart(document.getElementById('chartCorr'),'Corriente (A)','#22c55e');

// Detectar zoom/pan para desactivar autoScroll
[chartTemp, chartVolt, chartCorr].forEach(chart=>{
  chart.options.plugins.zoom.onZoom = ()=>{ if(chart===chartTemp) autoScrollTemp=false; if(chart===chartVolt) autoScrollVolt=false; if(chart===chartCorr) autoScrollCorr=false; };
  chart.options.plugins.zoom.onPan = ()=>{ if(chart===chartTemp) autoScrollTemp=false; if(chart===chartVolt) autoScrollVolt=false; if(chart===chartCorr) autoScrollCorr=false; };
});

// Actualizar grafico
function actualizarGrafico(chart,dataHist,slider,autoScrollFlag){
  const total = dataHist.length;
  const start = autoScrollFlag ? Math.max(0,total-MAX_POINTS) : parseInt(slider.value)||0;
  const visibleData = dataHist.slice(start,start+MAX_POINTS);
  chart.data.labels = visibleData.map(d=>d.time);
  chart.data.datasets[0].data = visibleData.map(d=>d.value);
  chart.update('none');
  slider.max = Math.max(0,total-MAX_POINTS);
  if(autoScrollFlag) slider.value=slider.max;
}

function agregarDato(chart,dataHist,value,now,slider,autoScrollFlag,tipo){
  if(isNaN(value)) return;
  let umbral=0;
  if(tipo==='temp') umbral=3;
  else if(tipo==='volt'||tipo==='corr') umbral=0.1;
  const lastPoint = dataHist.length ? dataHist[dataHist.length-1].value : value;
  const valorParaGrafico = Math.abs(value-lastPoint)>=umbral ? value : lastPoint;
  dataHist.push({time:now,value:valorParaGrafico});
  if(dataHist.length>MAX_POINTS*5) dataHist.splice(0,dataHist.length-MAX_POINTS*5);
  actualizarGrafico(chart,dataHist,slider,autoScrollFlag);
}

// Sliders
sliders.temp.addEventListener('input',()=>{autoScrollTemp=false; actualizarGrafico(chartTemp,dataTempHist,sliders.temp,false);});
sliders.volt.addEventListener('input',()=>{autoScrollVolt=false; actualizarGrafico(chartVolt,dataVoltHist,sliders.volt,false);});
sliders.corr.addEventListener('input',()=>{autoScrollCorr=false; actualizarGrafico(chartCorr,dataCorrHist,sliders.corr,false);});

// Reset zoom
btnResetZoom.onclick=()=>{
  chartTemp.resetZoom(); chartVolt.resetZoom(); chartCorr.resetZoom();
  autoScrollTemp=true; autoScrollVolt=true; autoScrollCorr=true;
  actualizarGrafico(chartTemp,dataTempHist,sliders.temp,true);
  actualizarGrafico(chartVolt,dataVoltHist,sliders.volt,true);
  actualizarGrafico(chartCorr,dataCorrHist,sliders.corr,true);
};

// BLE
btnConnect.onclick = async ()=>{
  try{
    log("Buscando ESP32...");
    device = await navigator.bluetooth.requestDevice({filters:[{name:'ESP32-C3-Mini'}],optionalServices:['6e400001-b5a3-f393-e0a9-e50e24dcca9e']});
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
    characteristicRX = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
    characteristicTX = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
    await characteristicRX.startNotifications();
    characteristicRX.addEventListener('characteristicvaluechanged', handleData);
    status.textContent="Conectado"; status.classList.add("status-connected");
    log("‚úÖ Conectado correctamente");
    enviarFechaHora();
  }catch(e){ status.textContent="Error"; log("‚ùå Error BLE: "+e);}
};

function enviarFechaHora(){
  if(!characteristicTX) return;

  const now = new Date();

  const fecha =
    now.getFullYear() + "-" +
    String(now.getMonth()+1).padStart(2,"0") + "-" +
    String(now.getDate()).padStart(2,"0");

  const hora =
    String(now.getHours()).padStart(2,"0") + ":" +
    String(now.getMinutes()).padStart(2,"0") + ":" +
    String(now.getSeconds()).padStart(2,"0");

  // üëá FORMATO CORRECTO PARA EL ESP32
  const cmd = `TIME,${fecha},${hora}`;
  characteristicTX.writeValueWithoutResponse(
    new TextEncoder().encode(cmd)
  );
}


// ================== HandleData ==================
function handleData(e){
  const t = new TextDecoder().decode(e.target.value).trim();

  // Mostrar mensaje SD
  if(t.toLowerCase().includes("sd") || t.toLowerCase().includes("grabando") || t.toLowerCase().includes("borrado") || t.toLowerCase().includes("error") || t.toLowerCase().includes("grabaci√≥n detenida")){
  logSD(t);

    // Solo si es confirmaci√≥n de inicio de grabaci√≥n
    if(t.toLowerCase().includes("grabando")){
      const recDot = document.querySelector("#recIndicator .rec-dot");
      const recTime = document.querySelector("#recIndicator .rec-time");

      recDot.className = "rec-dot rec-on";
      startTime = Date.now();
      recTime.textContent = "00:00";
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const minutes = String(Math.floor(elapsed / 60000)).padStart(2,'0');
        const seconds = String(Math.floor((elapsed % 60000)/1000)).padStart(2,'0');
        recTime.textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    // Si es mensaje de error, aseguramos detener REC
    if(t.toLowerCase().includes("error") || t.toLowerCase().includes("no hay sd")){
      recordingSD = false;
      const recDot = document.querySelector("#recIndicator .rec-dot");
      const recTime = document.querySelector("#recIndicator .rec-time");
      recDot.className = "rec-dot rec-off";
      recTime.textContent = "";
      clearInterval(timerInterval);
    }

  } else {
      log("RX: " + t);
  }

  const p=t.split(",");
  if(p.length<5) return;

  const temp=parseFloat(p[1]);
  const volt=parseFloat(p[2]);
  const corr=parseFloat(p[3]);
  const bat=p[4]==="0"?"OK":p[4]==="1"?"BAJA":"CRITICA";

  const d = new Date();

const fecha =
  d.getFullYear() + "-" +
  String(d.getMonth()+1).padStart(2,"0") + "-" +
  String(d.getDate()).padStart(2,"0");

const hora =
  String(d.getHours()).padStart(2,"0") + ":" +
  String(d.getMinutes()).padStart(2,"0") + ":" +
  String(d.getSeconds()).padStart(2,"0");

dataCSV.push([fecha, hora, temp, volt, corr, bat]);



  valTempAll.textContent=isNaN(temp)?"-- ¬∞C":temp.toFixed(2)+" ¬∞C";
  valVoltAll.textContent=isNaN(volt)?"-- V":volt.toFixed(2)+" V";
  valCorrAll.textContent=isNaN(corr)?"-- A":corr.toFixed(2)+" A";
  valBatAll.textContent=bat;

  valTemp.textContent=valTempAll.textContent;
  valVolt.textContent=valVoltAll.textContent;
  valCorr.textContent=valCorrAll.textContent;
  valBat.textContent=bat;

  if(!isNaN(temp)){ dataTemp.push(temp); if(dataTemp.length>MAX_POINTS) dataTemp.shift(); }
  if(!isNaN(volt)){ dataVolt.push(volt); if(dataVolt.length>MAX_POINTS) dataVolt.shift(); }
  if(!isNaN(corr)){ dataCorr.push(corr); if(dataCorr.length>MAX_POINTS) dataCorr.shift(); }

  if(dataTemp.length){ const avg=dataTemp.reduce((a,b)=>a+b,0)/dataTemp.length; avgTemp.textContent=avg.toFixed(2); maxTemp.textContent=Math.max(...dataTemp).toFixed(2); minTemp.textContent=Math.min(...dataTemp).toFixed(2);}
  if(dataVolt.length){ const avg=dataVolt.reduce((a,b)=>a+b,0)/dataVolt.length; avgVolt.textContent=avg.toFixed(2); maxVolt.textContent=Math.max(...dataVolt).toFixed(2); minVolt.textContent=Math.min(...dataVolt).toFixed(2);}
  if(dataCorr.length){ const avg=dataCorr.reduce((a,b)=>a+b,0)/dataCorr.length; avgCorr.textContent=avg.toFixed(2); maxCorr.textContent=Math.max(...dataCorr).toFixed(2); minCorr.textContent=Math.min(...dataCorr).toFixed(2);}


const now = hora;

  if(!isNaN(temp)) agregarDato(chartTemp,dataTempHist,temp,now,sliders.temp,autoScrollTemp,'temp');
  if(!isNaN(volt)) agregarDato(chartVolt,dataVoltHist,volt,now,sliders.volt,autoScrollVolt,'volt');
  if(!isNaN(corr)) agregarDato(chartCorr,dataCorrHist,corr,now,sliders.corr,autoScrollCorr,'corr');
}

// ================== Botones SD ==================
btnSD.onclick = async () => {
  if(!characteristicTX) return alert("ESP32 no conectado");

  const cmd = recordingSD ? "STOP" : "START";
  try {
    await characteristicTX.writeValueWithoutResponse(new TextEncoder().encode(cmd));
    logSD("Comando SD enviado: " + cmd);

    // Si es STOP, detenemos inmediatamente contador y animaci√≥n
    if(cmd === "STOP"){
      recordingSD = false;
      const recDot = document.querySelector("#recIndicator .rec-dot");
      const recTime = document.querySelector("#recIndicator .rec-time");
      recDot.className = "rec-dot rec-off";
      recTime.textContent = "";
      clearInterval(timerInterval);
    }

    // Si es START, solo marcamos la intenci√≥n, el contador real inicia al recibir "Grabando"
    if(cmd === "START"){
      recordingSD = true; // intenci√≥n de grabar
    }

  } catch(e) {
    logSD("‚ùå Error enviando comando SD: " + e);
    recordingSD = false;
  }
};

btnClearSD.onclick = async () => {
  if(!characteristicTX) return alert("ESP32 no conectado");
  try{
    await characteristicTX.writeValueWithoutResponse(new TextEncoder().encode("CLEAR"));
    logSD("Comando SD enviado: CLEAR");
  }catch(e){ logSD("‚ùå Error borrando SD: "+e); }

};

btnCSV.onclick = () => {
  if (!dataCSV.length) {
    alert("No hay datos para exportar");
    return;
  }

  let csv = "Fecha;Hora;Temperatura;Voltaje;Corriente;Bateria\n";


  dataCSV.forEach(row => {
    csv += row.join(";") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "datos_ESP32.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

};
const btnRSTmobile = document.getElementById('btnRSTmobile');

async function enviarReset() {
  if(!characteristicTX) return alert("ESP32 no conectado");
  if(!confirm("¬øResetear el ESP32?")) return;

  try {
    await characteristicTX.writeValueWithoutResponse(
      new TextEncoder().encode("RST")
    );
    log("üîÅ Reset enviado");

  setTimeout(() => {
      location.reload();
    }, 500); // medio segundo de espera para que el comando llegue
  } catch(e) {
    console.log("‚ùå Error enviando reset: " + e);
  }
}

// Conecta solo el bot√≥n que queda
if(btnRSTmobile) btnRSTmobile.onclick = enviarReset;



</script>
</body>
</html>
